select * from  [dbo].[org_user] where code = '230947'
23976
select * from [dbo].[org_rule_user] where user_id = '23976'
6349	23976
select * from [dbo].[org_group_user] where user_id = '23976'
3641	23976	0	1	1	2	NULL	NULL
8996	23976	0	0	1	2	NULL	NULL

5688	23976	0	1	1	2	NULL	NULL

select * from [dbo].[org_group] where group_id in ('5688','8996')

3641	11	-1	11	2	1	2	1	2014-11-23 18:31:36.000	2015-10-08 15:50:51.000	기타사용자	JJ_ETC	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
8996	11	21	1791	6	1	2	1	2015-12-31 12:33:22.000	2015-12-31 12:33:22.000	SAP(대리점A)	SAP_A	NULL	2015-12-31	9999-12-31	NULL	NULL	SAP(대리점A)	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL

/*********************************************************************
* 주스대리점 계정 퇴직처리 작업.
* 절차	1. 계정 비활성화 처리 status ='3' 
		2. 계정 rule_user 에서 제외처리. delete
		3. 계정 org_group_user 3641-> 5688 (기타사용자 그룹에서 퇴직자조직으로)
		* !테스트 계정 code 230947은 IM에서 퇴직 시켰으므로 해당 작업에서 제외처리.
		select @@trancount
**********************************************************************/
--org_rule_user에서 제외됨.  원복 : SAP(대리점A) group_id = 8996
--그룹은 퇴직자조직으로 처리됨. 원복 : 기타사용자 그룹 group_id = '3641'

begin tran
-- 임시테이블 생성
create table #code (code varchar(64))
-- drop table #code

insert into #code values 
('460406'),
('457988'),
('457954'),
('457662'),
('456264'),
('455251'),
('454764'),
('240396'),
('083337'),
('490979'),
('490895'),
('490855'),
('490675'),
('463124'),
('454641'),
('454518'),
('454270'),
('447882'),
('447870'),
('447869'),
('447851'),
('445957'),
('445326'),
('240367'),
('084088'),
('080597'),
('488939'),
('488309'),
('488301'),
('488050'),
('484375'),
('482545'),
('480232'),
('479895'),
('477265'),
('473904'),
('471067'),
('467053'),
('439951'),
('436996'),
('406877'),
('406701'),
('403896'),
('398024'),
('398008'),
('398005'),
('397985'),
('396766'),
('395006'),
('394594'),
('390926'),
('386733'),
('239505'),
('065388'),
('063348'),
('491020'),
('430563'),
('426771'),
('423391'),
('423358'),
('423353'),
('423033'),
('419683'),
('419549'),
('409362'),
('407153'),
('386637'),
('382498'),
('382479'),
('239907'),
('496725'),
('494448'),
('416944'),
('416886'),
('413088'),
('412788'),
('412751'),
('412561'),
('412301'),
('409773'),
('382478'),
('241114'),
('187648'),
('182084'),
('170472'),
('169601'),
('068212'),
('241098'),
('241096'),
('241058'),
('240963'),
('240953'),
('240943'),
('221712'),
('220124'),
('193387'),
('191913'),
('188886'),
('188803'),
('161194'),
('151545'),
('151229'),
('146497'),
('143390'),
('141489'),
('140133'),
('139299'),
('241288'),
('241272'),
('241259'),
('241201'),
('215621'),
('212552'),
('212514'),
('205737'),
('196454'),
('195161'),
('193602'),
('136908'),
('136430'),
('519030'),
('518856'),
('516376'),
('516374'),
('516355'),
('512927'),
('507307'),
('503442'),
('502557'),
('240764'),
('240756'),
('240660'),
('240658'),
('098017'),
('092641'),
('091196'),
('089588'),
('502430'),
('499717'),
('499444'),
('496414'),
('240929'),
('240928'),
('240919'),
('240917'),
('240907'),
('240902'),
('134539'),
('131477'),
('126240'),
('108586'),
('104754'),
('382391'),
('240811'),
('230271'),
('123325'),
('123283'),
('121690'),
('117593'),
('115927'),
('115586'),
('115555'),
('108739'),
('105902'),
('007429'),
('006404'),
('230270'),
('230262'),
('230148'),
('061629'),
('056124'),
('028758'),
('011508'),
('007964'),
('007791'),
('006333'),
('006322'),
('005923'),
('003147'),
('230887'),
('230846'),
('230828'),
('230813'),
('230609'),
('230603'),
('230494'),
('230397'),
('084850'),
('022772'),
('018796'),
('018760'),
('016469'),
('016451'),
('014588'),
('326761'),
('326759'),
('326758'),
('326757'),
('326754'),
('025602'),
('326763'),
('326762'),
('326753'),
('326752'),
('326750'),
('326749'),
('326735'),
('241328'),
('241222'),
('240526'),
('236769'),
('236059'),
('236058'),
('236049'),
('233169'),
('229285'),
('219777'),
('164038'),
('161697'),
('057959'),
('377419'),
('377355'),
('375816'),
('374169'),
('371511'),
('371086'),
('370850'),
('370755'),
('370706'),
('353818'),
('327554'),
('326784'),
('326783'),
('326779'),
('326778'),
('326768'),
('326765'),
('238932'),
('061107'),
('060745'),
('326767'),
('326766'),
('326764'),
('235413'),
('231228'),
('103515'),
('052232'),
('037890'),
('037874'),
('037791'),
('037776'),
('036594'),
('036439'),
('035842'),
('033776'),
('032614'),
('032480'),
('032474'),
('236024'),
('234709'),
('234188'),
('231497'),
('231188'),
('231120'),
('128732'),
('121923'),
('089288'),
('045002'),
('044607'),
('041085'),
('041047'),
('038885'),
('027958'),
('026244'),
('025606'),
('025604'),
('231555'),
('231537'),
('231521'),
('111197'),
('111082'),
('108383'),
('040939'),
('040234'),
('038883'),
('521300'),
('521071'),
('521336'),
('521108'),
('235344'),
('523831'),
('526062'),
('526673'),
('528985'),
('536356'),
('534790'),
('542419'),
('542971'),
('543048'),
('545836'),
('549267'),
('240911'),
('557935'),
('558053'),
('558139'),
('186030'),
('205939'),
('561353'),
('561355')

--1. 작업
begin tran 
update [dbo].[org_user]
set status = '3', ex_description = '구erp사용목적이던 주스대리점 삭제처리. 담당자 : 임경혁 사원', modify_dt = GETDATE() 
where code in (select code from #code )

select * from  [dbo].[org_user] where code in (select code from #code )

rollback

--2. 작업
begin tran
delete [dbo].[org_rule_user] 
where user_id in (select user_id from [dbo].[org_user] where code in (select code from #code ))
rollback

--롤백 시나리오
6349	23712
select * from [dbo].[org_rule_user]  where user_id in (select user_id from [dbo].[org_user] where code in (select code from #code ))
insert into [dbo].[org_rule_user] values ('6349','user_id')


--3. 작업
begin tran 
delete [dbo].[org_group_user]
where relation_type = '0' AND user_id in (select user_id from [dbo].[org_user] where code in (select code from #code ))

begin tran 
update  [dbo].[org_group_user]
set group_id = '5688'   --퇴직자조직 group_id = '5688'
where relation_type = '1' AND user_id in (select user_id from [dbo].[org_user] where code in (select code from #code ))
rollback

-- 롤백 시나리오
3641	23884	0	1	1	2	NULL	NULL
8996	23884	0	0	1	2	NULL	NULL
select * from [dbo].[org_group_user] 
where user_id in (select user_id from [dbo].[org_user] where code in (select code from #code ))

1. 
begin tran
update [dbo].[org_group_user]
set group_id = '3641'
where relation_type = '1' AND user_id in (select user_id from [dbo].[org_user] where code in (select code from #code ))
rollback
2. 
begin tran
insert into [dbo].[org_group_user] values ('8996','user_id','0','0','1','2',NULL,NULL)
rollback




















































































































































































































